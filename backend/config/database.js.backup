const mysql = require('mysql2');

// ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
const dbConfig = {
  user: process.env.DB_USER || 'canavias_admin',
  password: process.env.DB_PASSWORD || '123456',
  database: process.env.DB_NAME || 'personnel_management_system',
  socketPath: process.env.DB_SOCKET || '/run/mysqld/mysqld.sock',
  charset: 'utf8mb4',
  timezone: '+08:00',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
};

const pool = mysql.createPool(dbConfig);

// åœ¨è·å–è¿æ¥æ—¶è®¾ç½®å­—ç¬¦é›†
pool.on('connection', (connection) => {
  connection.query("SET NAMES 'utf8mb4'");
  connection.query("SET CHARACTER SET 'utf8mb4'");
  connection.query("SET character_set_connection = 'utf8mb4'");
});

// æµ‹è¯•è¿æ¥
pool.getConnection((err, connection) => {
  if (err) {
    console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', err.message);
    console.error('ğŸ”§ è¿æ¥é…ç½®:', {
      user: dbConfig.user,
      database: dbConfig.database,
      socketPath: dbConfig.socketPath
    });
    return;
  }
  console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ - ä½¿ç”¨socketè¿æ¥');
  console.log('ğŸ”§ è¿æ¥ä¿¡æ¯:', {
    user: dbConfig.user,
    database: dbConfig.database,
    socketPath: dbConfig.socketPath
  });
  connection.release();
});

module.exports = {
  pool: pool.promise()
};

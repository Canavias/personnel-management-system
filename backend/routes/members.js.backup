const express = require('express');
const router = express.Router();
const { pool } = require('../config/database');

// ä¿®å¤çš„æ€§åˆ«è½¬æ¢å‡½æ•° - ç°åœ¨genderå­—æ®µæ˜¯æ•°å­—
function convertGenderToValue(gender) {
  console.log('ğŸ” æ€§åˆ«è½¬æ¢ - è¾“å…¥:', gender, 'ç±»å‹:', typeof gender);
  
  // å¦‚æœå·²ç»æ˜¯æ•°å­—ï¼Œç›´æ¥è¿”å›
  if (typeof gender === 'number') {
    return gender;
  }
  
  // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºæ•°å­—
  const genderMap = { 'ç”·': 1, 'å¥³': 2, 'å…¶ä»–': 3 };
  const result = genderMap[gender] || 1;
  console.log('ğŸ” æ€§åˆ«è½¬æ¢ - è¾“å‡º:', result);
  return result;
}

function convertValueToGender(value) {
  console.log('ğŸ” æ€§åˆ«åå‘è½¬æ¢ - è¾“å…¥:', value, 'ç±»å‹:', typeof value);
  
  // ç¡®ä¿valueæ˜¯æ•°å­—
  let genderValue = value;
  if (typeof value === 'string') {
    genderValue = parseInt(value);
  }
  
  const genderMap = { 1: 'ç”·', 2: 'å¥³', 3: 'å…¶ä»–' };
  const result = genderMap[genderValue] || 'ç”·';
  console.log('ğŸ” æ€§åˆ«åå‘è½¬æ¢ - è¾“å‡º:', result);
  return result;
}

// ä¿®å¤å‚æ•°å¤„ç†å‡½æ•°
function sanitizeUpdateParams(params) {
  console.log('ğŸ§¹ åŸå§‹å‚æ•°:', params);
  
  const sanitized = {};
  const fields = ['name', 'gender', 'grade', 'student_id', 'phone', 'email', 
                  'department_id', 'role_id', 'is_active'];
  
  fields.forEach(field => {
    if (params[field] === undefined) {
      switch(field) {
        case 'is_active':
          sanitized[field] = true;
          break;
        case 'department_id':
        case 'role_id':
          sanitized[field] = null;
          break;
        case 'name':
        case 'gender':
        case 'grade':
          sanitized[field] = field === 'gender' ? 'ç”·' : '';
          break;
        default:
          sanitized[field] = null;
      }
    } else {
      sanitized[field] = params[field];
    }
  });
  
  return sanitized;
}

// ä¿®å¤çš„è·å–æ‰€æœ‰æˆå‘˜å‡½æ•°
router.get('/', async (req, res) => {
  try {
    console.log('ğŸ”„ è·å–æ‰€æœ‰æˆå‘˜åˆ—è¡¨');
    const [rows] = await pool.execute(`
      SELECT 
        m.*,
        d.name as department_name,
        r.title as role_title
      FROM members m
      LEFT JOIN departments d ON m.department_id = d.id
      LEFT JOIN roles r ON m.role_id = r.id
      WHERE m.is_active = true
      ORDER BY m.id
    `);
    
    console.log('ğŸ“Š æ•°æ®åº“åŸå§‹æ•°æ®ï¼ˆå‰3æ¡ï¼‰:');
    rows.slice(0, 3).forEach(row => {
      console.log(`  ID ${row.id}: ${row.name} - æ€§åˆ«å€¼: ${row.gender} (ç±»å‹: ${typeof row.gender})`);
    });
    
    // ä¿®å¤çš„è½¬æ¢é€»è¾‘
    const processedRows = rows.map(row => {
      let genderValue;
      
      if (typeof row.gender === 'number') {
        genderValue = row.gender;
      } else if (typeof row.gender === 'string') {
        // å°è¯•è§£æä¸ºæ•°å­—
        genderValue = parseInt(row.gender);
        if (isNaN(genderValue)) {
          // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è½¬æ¢
          if (row.gender.includes('ç”·') || row.gender.includes('Ã§')) genderValue = 1;
          else if (row.gender.includes('å¥³') || row.gender.includes('Ã¥')) genderValue = 2;
          else genderValue = 1;
        }
      } else {
        genderValue = 1;
      }
      
      return {
        ...row,
        gender: convertValueToGender(genderValue)
      };
    });
    
    console.log('ğŸ“¤ å¤„ç†åæ•°æ®ï¼ˆå‰3æ¡ï¼‰:');
    processedRows.slice(0, 3).forEach(row => {
      console.log(`  ID ${row.id}: ${row.name} - æ€§åˆ«: ${row.gender}`);
    });
    
    res.json(processedRows);
  } catch (error) {
    console.error('è·å–æˆå‘˜åˆ—è¡¨å¤±è´¥:', error);
    res.status(500).json({ error: 'è·å–æˆå‘˜åˆ—è¡¨å¤±è´¥' });
  }
});

// ä¿æŒå…¶ä»–è·¯ç”±ä¸å˜ï¼ˆä½¿ç”¨ä¹‹å‰çš„ä¿®å¤ç‰ˆæœ¬ï¼‰
// ... [å…¶ä»–è·¯ç”±ä»£ç ä¿æŒä¸å˜] ...

module.exports = router;

// ç¡®ä¿PUTè·¯ç”±å­˜åœ¨
router.put('/:id', async (req, res) => {
  console.log('ğŸ”„ PUT /api/members/' + req.params.id + ' è¢«è°ƒç”¨');
  
  try {
    const { id } = req.params;
    const { name, gender, grade, student_id, phone, email, department_id, role_id, is_active } = req.body;

    console.log('ğŸ“¦ è¯·æ±‚æ•°æ®:', JSON.stringify(req.body, null, 2));

    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!name) {
      return res.status(400).json({ 
        success: false, 
        message: 'å§“åä¸èƒ½ä¸ºç©º' 
      });
    }

    // è½¬æ¢æ€§åˆ«
    const genderValue = gender === 'ç”·' ? 1 : gender === 'å¥³' ? 2 : 3;

    // ç«™é•¿é€»è¾‘
    let actualDepartmentId = department_id;
    if (role_id === 1) { // ç«™é•¿
      actualDepartmentId = null;
    }

    const [result] = await pool.execute(
      `UPDATE members 
       SET name = ?, gender = ?, grade = ?, student_id = ?, phone = ?, email = ?, 
           department_id = ?, role_id = ?, is_active = ?, updated_at = CURRENT_TIMESTAMP 
       WHERE id = ?`,
      [
        name || '',
        genderValue,
        grade || '',
        student_id || null,
        phone || null,
        email || null,
        actualDepartmentId,
        role_id || null,
        is_active !== undefined ? is_active : true,
        id
      ]
    );

    if (result.affectedRows === 0) {
      return res.status(404).json({ 
        success: false, 
        message: 'æˆå‘˜ä¸å­˜åœ¨' 
      });
    }

    res.json({
      success: true,
      message: 'æˆå‘˜æ›´æ–°æˆåŠŸ',
      data: { id }
    });

  } catch (error) {
    console.error('æ›´æ–°æˆå‘˜å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'æ›´æ–°å¤±è´¥: ' + error.message
    });
  }
});

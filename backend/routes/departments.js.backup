const express = require('express');
const { pool } = require('../config/database');
const authMiddleware = require('../middleware/auth');

const router = express.Router();

// è®¾ç½®å“åº”å­—ç¬¦é›†ä¸­é—´ä»¶
router.use((req, res, next) => {
  res.setHeader('Content-Type', 'application/json; charset=utf-8');
  next();
});

// è·å–æ‰€æœ‰éƒ¨é—¨
router.get('/', authMiddleware, async (req, res) => {
  try {
    console.log('ğŸ” å¼€å§‹è·å–éƒ¨é—¨åˆ—è¡¨...');
    const [departments] = await pool.execute('SELECT * FROM departments');
    console.log('âœ… éƒ¨é—¨åˆ—è¡¨æŸ¥è¯¢æˆåŠŸï¼Œæ•°é‡:', departments.length);
    
    res.json({
      success: true,
      data: departments,
      total: departments.length
    });
  } catch (error) {
    console.error('âŒ è·å–éƒ¨é—¨åˆ—è¡¨å¤±è´¥:', error.message);
    res.status(500).json({ 
      success: false,
      error: 'è·å–éƒ¨é—¨åˆ—è¡¨å¤±è´¥',
      message: error.message
    });
  }
});

// è·å–éƒ¨é—¨ç»Ÿè®¡ä¿¡æ¯
router.get('/stats', authMiddleware, async (req, res) => {
  try {
    console.log('ğŸ” å¼€å§‹è·å–éƒ¨é—¨ç»Ÿè®¡...');
    const [stats] = await pool.execute(`
      SELECT 
        d.id as department_id,
        d.name as department_name,
        COUNT(m.id) as member_count
      FROM departments d
      LEFT JOIN members m ON d.id = m.department_id AND m.is_active = 1
      GROUP BY d.id, d.name
      ORDER BY d.id
    `);
    console.log('âœ… éƒ¨é—¨ç»Ÿè®¡æŸ¥è¯¢æˆåŠŸï¼Œæ•°é‡:', stats.length);
    
    res.json({
      success: true,
      data: stats
    });
  } catch (error) {
    console.error('âŒ è·å–éƒ¨é—¨ç»Ÿè®¡å¤±è´¥:', error.message);
    res.status(500).json({ 
      success: false,
      error: 'è·å–éƒ¨é—¨ç»Ÿè®¡å¤±è´¥',
      message: error.message
    });
  }
});

// è·å–éƒ¨é—¨è¯¦æƒ…åŠæˆå‘˜
router.get('/:id', authMiddleware, async (req, res) => {
  try {
    const departmentId = req.params.id;
    console.log('ğŸ” è·å–éƒ¨é—¨è¯¦æƒ…ï¼ŒID:', departmentId);
    
    const [departments] = await pool.execute(
      'SELECT * FROM departments WHERE id = ?', 
      [departmentId]
    );
    
    if (departments.length === 0) {
      return res.status(404).json({ 
        success: false,
        error: 'éƒ¨é—¨ä¸å­˜åœ¨' 
      });
    }
    
    const [members] = await pool.execute(
      `SELECT m.*, r.title as role_name
       FROM members m
       LEFT JOIN roles r ON m.role_id = r.id
       WHERE m.department_id = ? AND m.is_active = 1
       ORDER BY m.name`,
      [departmentId]
    );
    
    res.json({
      success: true,
      data: {
        ...departments[0],
        members: members
      }
    });
  } catch (error) {
    console.error('âŒ è·å–éƒ¨é—¨è¯¦æƒ…å¤±è´¥:', error.message);
    res.status(500).json({ 
      success: false,
      error: 'è·å–éƒ¨é—¨è¯¦æƒ…å¤±è´¥',
      message: error.message
    });
  }
});

module.exports = router;

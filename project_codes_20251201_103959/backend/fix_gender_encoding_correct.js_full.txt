=== ./backend/fix_gender_encoding_correct.js ===
const mysql = require('mysql2');

// ä½¿ç”¨ä¸é¡¹ç›®ç›¸åŒçš„æ•°æ®åº“é…ç½®
const dbConfig = {
  user: 'canavias_admin',
  password: 'rw7719lxy',
  database: 'personnel_management_system',
  socketPath: '/run/mysqld/mysqld.sock',
  charset: 'utf8mb4',
  timezone: '+08:00'
};

async function fixGenderEncoding() {
  const pool = mysql.createPool(dbConfig);
  
  try {
    console.log('ğŸ”§ å¼€å§‹ä¿®å¤æ€§åˆ«å­—æ®µç¼–ç é—®é¢˜...');

    // é¦–å…ˆæ£€æŸ¥å½“å‰æ•°æ®
    const [rows] = await pool.promise().execute('SELECT id, name, gender FROM members');
    console.log('ğŸ“Š å½“å‰æˆå‘˜æ€§åˆ«æ•°æ®:');
    rows.forEach(row => {
      console.log(`  ID ${row.id}: ${row.name} - æ€§åˆ«å€¼: ${row.gender} (ç±»å‹: ${typeof row.gender})`);
    });

    // ä¿®å¤æ€§åˆ«å­—æ®µ - ç›´æ¥è®¾ç½®æ­£ç¡®çš„æ•´æ•°å€¼
    console.log('ğŸ”„ ä¿®å¤æ€§åˆ«å­—æ®µ...');
    
    // æ–¹æ³•1ï¼šç›´æ¥æ›´æ–°ä¸ºæ­£ç¡®çš„æ•´æ•°å€¼
    const updateQueries = [
      "UPDATE members SET gender = 1 WHERE gender = 'ç”·' OR gender = 1",
      "UPDATE members SET gender = 2 WHERE gender = 'å¥³' OR gender = 2", 
      "UPDATE members SET gender = 3 WHERE gender = 'å…¶ä»–' OR gender = 3"
    ];
    
    for (const query of updateQueries) {
      const [result] = await pool.promise().execute(query);
      console.log(`  æ‰§è¡Œ: ${query} - å½±å“è¡Œæ•°: ${result.affectedRows}`);
    }
    
    // æ–¹æ³•2ï¼šå¯¹äºä¹±ç æ•°æ®ï¼Œæ ¹æ®IDæ‰‹åŠ¨è®¾ç½®
    const manualUpdates = [
      [1, 5],   // ID 5 è®¾ç½®ä¸ºç”·
      [2, 7],   // ID 7 è®¾ç½®ä¸ºç”·  
      [1, 8],   // ID 8 è®¾ç½®ä¸ºç”·
      [1, 9],   // ID 9 è®¾ç½®ä¸ºç”·
      [1, 10],  // ID 10 è®¾ç½®ä¸ºç”·
      [1, 11],  // ID 11 è®¾ç½®ä¸ºç”·
      [2, 12],  // ID 12 è®¾ç½®ä¸ºå¥³ï¼ˆæµ‹è¯•ç”¨ï¼‰
      [1, 13],  // ID 13 è®¾ç½®ä¸ºç”·
      [1, 14]   // ID 14 è®¾ç½®ä¸ºç”·
    ];
    
    for (const [genderValue, id] of manualUpdates) {
      await pool.promise().execute('UPDATE members SET gender = ? WHERE id = ?', [genderValue, id]);
      console.log(`  è®¾ç½®ID ${id} çš„æ€§åˆ«ä¸º: ${genderValue}`);
    }

    // éªŒè¯ä¿®å¤ç»“æœ
    const [fixedRows] = await pool.promise().execute('SELECT id, name, gender FROM members ORDER BY id');
    console.log('âœ… ä¿®å¤åçš„æˆå‘˜æ€§åˆ«æ•°æ®:');
    fixedRows.forEach(row => {
      const genderText = row.gender === 1 ? 'ç”·' : row.gender === 2 ? 'å¥³' : 'å…¶ä»–';
      console.log(`  ID ${row.id}: ${row.name} - æ€§åˆ«: ${genderText} (å­˜å‚¨å€¼: ${row.gender})`);
    });

    console.log('ğŸ‰ æ€§åˆ«å­—æ®µç¼–ç ä¿®å¤å®Œæˆï¼');
    
  } catch (error) {
    console.error('ä¿®å¤å¤±è´¥:', error);
  } finally {
    pool.end();
  }
}

fixGenderEncoding();




=== ./backend/routes/performance.js ===
const express = require('express');
const router = express.Router();
const db = require('../config/database');

// è·å–ç»©æ•ˆè¯„ä¼°è¡¨ï¼ˆæ’é™¤ç«™é•¿ã€éƒ¨é•¿ã€å‰¯éƒ¨é•¿ï¼‰
router.get('/', async (req, res) => {
  try {
    console.log('ğŸ” å¼€å§‹è·å–ç»©æ•ˆè¯„ä¼°è¡¨...');
    
    // ç›´æ¥ä½¿ç”¨å·²çŸ¥çš„è§’è‰²IDè¿›è¡Œæ’é™¤
    const excludeRoleIds = [1, 2, 3]; // ç«™é•¿ã€éƒ¨é•¿ã€å‰¯éƒ¨é•¿
    
    const placeholders = excludeRoleIds.map(() => '?').join(',');
    
    console.log('æ’é™¤çš„è§’è‰²ID:', excludeRoleIds);
    
    // æŸ¥è¯¢ç»©æ•ˆæ•°æ® - ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå title
    const [performance] = await db.pool.execute(`
      SELECT 
        m.id,
        m.name,
        m.gender,
        m.grade,
        m.department_id,
        d.name as department_name,
        m.role_id,
        r.title as role_name,  -- ä¿®æ­£ä¸º title å­—æ®µ
        COALESCE(p.score, 0) as performance_score,
        COALESCE(p.comments, '') as performance_comments,
        COALESCE(p.evaluated_at, NOW()) as evaluated_at
      FROM members m
      LEFT JOIN departments d ON m.department_id = d.id
      LEFT JOIN roles r ON m.role_id = r.id
      LEFT JOIN performance p ON m.id = p.member_id
      WHERE m.role_id NOT IN (${placeholders})
        AND m.is_active = 1
      ORDER BY d.name, m.name
    `, excludeRoleIds);
    
    console.log('âœ… ç»©æ•ˆè¯„ä¼°è¡¨æŸ¥è¯¢æˆåŠŸï¼Œæ•°é‡:', performance.length);
    
    res.json({
      success: true,
      data: performance,
      total: performance.length
    });
  } catch (error) {
    console.error('âŒ è·å–ç»©æ•ˆè¯„ä¼°è¡¨å¤±è´¥:', error.message);
    res.status(500).json({ 
      success: false,
      error: 'è·å–ç»©æ•ˆè¯„ä¼°è¡¨å¤±è´¥',
      message: error.message
    });
  }
});

// æŒ‰ç»©æ•ˆè¯„åˆ†æ’åº
router.get('/sorted/:order', async (req, res) => {
  try {
    const order = req.params.order.toUpperCase();
    const validOrders = ['ASC', 'DESC'];
    
    if (!validOrders.includes(order)) {
      return res.status(400).json({
        success: false,
        error: 'æ’åºå‚æ•°æ— æ•ˆï¼Œè¯·ä½¿ç”¨ ASC æˆ– DESC'
      });
    }
    
    console.log(`ğŸ” å¼€å§‹è·å–æŒ‰ç»©æ•ˆ${order === 'ASC' ? 'å‡åº' : 'é™åº'}æ’åˆ—çš„æ•°æ®...`);
    
    const excludeRoleIds = [1, 2, 3];
    const placeholders = excludeRoleIds.map(() => '?').join(',');
    
    const [performance] = await db.pool.execute(`
      SELECT 
        m.id,
        m.name,
        m.gender,
        m.grade,
        m.department_id,
        d.name as department_name,
        m.role_id,
        r.title as role_name,  -- ä¿®æ­£ä¸º title å­—æ®µ
        COALESCE(p.score, 0) as performance_score,
        COALESCE(p.comments, '') as performance_comments,
        COALESCE(p.evaluated_at, NOW()) as evaluated_at
      FROM members m
      LEFT JOIN departments d ON m.department_id = d.id
      LEFT JOIN roles r ON m.role_id = r.id
      LEFT JOIN performance p ON m.id = p.member_id
      WHERE m.role_id NOT IN (${placeholders})
        AND m.is_active = 1
      ORDER BY performance_score ${order}, d.name, m.name
    `, excludeRoleIds);
    
    console.log(`âœ… æŒ‰ç»©æ•ˆ${order === 'ASC' ? 'å‡åº' : 'é™åº'}æ’åˆ—æˆåŠŸï¼Œæ•°é‡:`, performance.length);
    
    res.json({
      success: true,
      data: performance,
      total: performance.length,
      order: order
    });
  } catch (error) {
    console.error('âŒ è·å–æ’åºç»©æ•ˆæ•°æ®å¤±è´¥:', error.message);
    res.status(500).json({ 
      success: false,
      error: 'è·å–æ’åºç»©æ•ˆæ•°æ®å¤±è´¥',
      message: error.message
    });
  }
});

// æŒ‰éƒ¨é—¨è·å–ç»©æ•ˆæ•°æ®
router.get('/departments/:id', async (req, res) => {
  try {
    const departmentId = req.params.id;
    console.log(`ğŸ” å¼€å§‹è·å–éƒ¨é—¨ ${departmentId} çš„ç»©æ•ˆæ•°æ®...`);
    
    const excludeRoleIds = [1, 2, 3];
    const placeholders = excludeRoleIds.map(() => '?').join(',');
    
    const [performance] = await db.pool.execute(`
      SELECT 
        m.id,
        m.name,
        m.gender,
        m.grade,
        m.department_id,
        d.name as department_name,
        m.role_id,
        r.title as role_name,  -- ä¿®æ­£ä¸º title å­—æ®µ
        COALESCE(p.score, 0) as performance_score,
        COALESCE(p.comments, '') as performance_comments,
        COALESCE(p.evaluated_at, NOW()) as evaluated_at
      FROM members m
      LEFT JOIN departments d ON m.department_id = d.id
      LEFT JOIN roles r ON m.role_id = r.id
      LEFT JOIN performance p ON m.id = p.member_id
      WHERE m.department_id = ?
        AND m.role_id NOT IN (${placeholders})
        AND m.is_active = 1
      ORDER BY m.name
    `, [departmentId, ...excludeRoleIds]);
    
    console.log(`âœ… éƒ¨é—¨ ${departmentId} ç»©æ•ˆæ•°æ®æŸ¥è¯¢æˆåŠŸï¼Œæ•°é‡:`, performance.length);
    
    res.json({
      success: true,
      data: performance,
      total: performance.length,
      department_id: parseInt(departmentId)
    });
  } catch (error) {
    console.error('âŒ è·å–éƒ¨é—¨ç»©æ•ˆæ•°æ®å¤±è´¥:', error.message);
    res.status(500).json({ 
      success: false,
      error: 'è·å–éƒ¨é—¨ç»©æ•ˆæ•°æ®å¤±è´¥',
      message: error.message
    });
  }
});

module.exports = router;




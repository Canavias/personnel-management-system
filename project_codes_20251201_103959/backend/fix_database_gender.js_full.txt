=== ./backend/fix_database_gender.js ===
const mysql = require('mysql2/promise');

async function fixDatabaseGender() {
  console.log('ğŸ”§ å¼€å§‹ä¿®å¤æ•°æ®åº“æ€§åˆ«å­—æ®µ...');
  
  const pool = mysql.createPool({
    user: 'canavias_admin',
    password: 'rw7719lxy',
    database: 'personnel_management_system',
    socketPath: '/run/mysqld/mysqld.sock',
    charset: 'utf8mb4'
  });
  
  try {
    // 1. å…ˆæŸ¥çœ‹å½“å‰æ•°æ®
    console.log('ğŸ“Š æŸ¥çœ‹å½“å‰æˆå‘˜æ€§åˆ«æ•°æ®:');
    const [rows] = await pool.execute('SELECT id, name, gender FROM members ORDER BY id');
    
    rows.forEach(row => {
      console.log(`  ID ${row.id}: ${row.name} - æ€§åˆ«: ${row.gender} (åŸå§‹å€¼)`);
    });
    
    // 2. ä¿®å¤æ€§åˆ«å­—æ®µ - ä¸´æ—¶å°†ä¹±ç è½¬æ¢ä¸ºæ•°å­—
    console.log('\nğŸ”„ ä¿®å¤æ€§åˆ«å­—æ®µ...');
    
    // å°†ä¹±ç çš„"ç”·"(Ã§â€Â·)è½¬æ¢ä¸ºæ•°å­—1
    await pool.execute("UPDATE members SET gender = '1' WHERE gender = 'Ã§â€Â·' OR gender = 1");
    
    // å°†ä¹±ç çš„"å¥³"(Ã¥Â¥Â³)è½¬æ¢ä¸ºæ•°å­—2
    await pool.execute("UPDATE members SET gender = '2' WHERE gender = 'Ã¥Â¥Â³' OR gender = 2");
    
    // å°†ä¹±ç çš„"å…¶ä»–"(Ã¥â€¦Â¶Ã¤Â»â€“)è½¬æ¢ä¸ºæ•°å­—3
    await pool.execute("UPDATE members SET gender = '3' WHERE gender = 'Ã¥â€¦Â¶Ã¤Â»â€“' OR gender = 3");
    
    // 3. ä¿®æ”¹è¡¨ç»“æ„ï¼Œå°†enumæ”¹ä¸ºtinyint
    console.log('\nğŸ—ï¸ ä¿®æ”¹è¡¨ç»“æ„...');
    
    // å¤‡ä»½åŸæ¥çš„æ•°æ®
    await pool.execute('CREATE TABLE IF NOT EXISTS members_backup SELECT * FROM members');
    
    // ä¿®æ”¹genderå­—æ®µç±»å‹
    await pool.execute(`
      ALTER TABLE members 
      MODIFY COLUMN gender TINYINT(1) NOT NULL DEFAULT 1
      COMMENT '1:ç”·, 2:å¥³, 3:å…¶ä»–'
    `);
    
    // 4. éªŒè¯ä¿®å¤ç»“æœ
    console.log('\nâœ… ä¿®å¤å®Œæˆï¼ŒéªŒè¯ç»“æœ:');
    const [fixedRows] = await pool.execute('SELECT id, name, gender FROM members ORDER BY id');
    
    fixedRows.forEach(row => {
      let genderText;
      if (row.gender === 1) genderText = 'ç”·';
      else if (row.gender === 2) genderText = 'å¥³';
      else if (row.gender === 3) genderText = 'å…¶ä»–';
      else genderText = 'æœªçŸ¥';
      
      console.log(`  ID ${row.id}: ${row.name} - æ€§åˆ«: ${genderText} (å­˜å‚¨å€¼: ${row.gender})`);
    });
    
    console.log('\nğŸ‰ æ•°æ®åº“æ€§åˆ«å­—æ®µä¿®å¤å®Œæˆï¼');
    
  } catch (error) {
    console.error('âŒ ä¿®å¤å¤±è´¥:', error);
  } finally {
    await pool.end();
  }
}

fixDatabaseGender();




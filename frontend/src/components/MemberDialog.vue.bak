<template>
  <el-dialog
    v-model="dialogVisible"
    :title="dialogTitle"
    width="500px"
    :before-close="handleBeforeClose"
  >
    <el-form
      ref="formRef"
      :model="form"
      :rules="rules"
      label-width="80px"
      status-icon
    >
      <el-form-item label="å§“å" prop="name">
        <el-input v-model="form.name" placeholder="è¯·è¾“å…¥å§“å" />
      </el-form-item>

      <el-form-item label="æ€§åˆ«" prop="gender">
        <el-radio-group v-model="form.gender">
          <el-radio label="ç”·">ç”·</el-radio>
          <el-radio label="å¥³">å¥³</el-radio>
          <el-radio label="å…¶ä»–">å…¶ä»–</el-radio>
        </el-radio-group>
      </el-form-item>

      <el-form-item label="å¹´çº§" prop="grade">
        <el-select v-model="form.grade" placeholder="è¯·é€‰æ‹©å¹´çº§" style="width: 100%">
          <el-option label="2021çº§" value="2021çº§" />
          <el-option label="2022çº§" value="2022çº§" />
          <el-option label="2023çº§" value="2023çº§" />
          <el-option label="2024çº§" value="2024çº§" />
          <el-option label="2025çº§" value="2025çº§" />
        </el-select>
      </el-form-item>

      <el-form-item label="æ‰‹æœº" prop="phone">
        <el-input v-model="form.phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
      </el-form-item>

      <el-form-item label="é‚®ç®±" prop="email">
        <el-input v-model="form.email" placeholder="è¯·è¾“å…¥é‚®ç®±" />
      </el-form-item>

      <el-form-item label="èŒä½" prop="role_id">
        <el-select v-model="form.role_id" placeholder="è¯·é€‰æ‹©èŒä½" style="width: 100%" @change="handleRoleChange">
          <el-option label="ç«™é•¿" :value="1" />
          <el-option label="éƒ¨é•¿" :value="2" />
          <el-option label="å‰¯éƒ¨é•¿" :value="3" />
          <el-option label="è´Ÿè´£äºº" :value="4" />
          <el-option label="æˆå‘˜" :value="5" />
        </el-select>
      </el-form-item>

      <el-form-item 
        v-if="form.role_id !== 1"
        label="éƒ¨é—¨" 
        prop="department_id"
      >
        <el-select v-model="form.department_id" placeholder="è¯·é€‰æ‹©éƒ¨é—¨" style="width: 100%">
          <el-option label="ç¨‹åºéƒ¨" :value="1" />
          <el-option label="æ¸¸æˆéƒ¨" :value="2" />
          <el-option label="Webéƒ¨" :value="3" />
          <el-option label="UIéƒ¨" :value="4" />
          <el-option label="Appéƒ¨" :value="5" />
          <el-option label="iOSéƒ¨" :value="7" />
          <el-option label="ç²¾è‹±åŸ¹ä¼˜ç­" :value="6" />
        </el-select>
      </el-form-item>

      <el-form-item v-if="form.role_id === 1">
        <el-alert
          title="ç«™é•¿ä¸å±äºä»»ä½•éƒ¨é—¨"
          type="info"
          :closable="false"
          show-icon
        />
      </el-form-item>
    </el-form>

    <template #footer>
      <span class="dialog-footer">
        <el-button @click="handleClose">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleSubmit" :loading="loading">
          ç¡®è®¤
        </el-button>
      </span>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, reactive, watch, nextTick, computed } from 'vue'
import { ElMessage, type FormInstance, type FormRules } from 'element-plus'
import { useMemberStore } from '@/stores/member'

interface MemberForm {
  id?: number
  name: string
  gender: string
  grade: string
  phone: string
  email: string
  department_id: number | null
  role_id: number | null
}

const props = defineProps<{
  modelValue: boolean
  editData?: any
}>()

const emit = defineEmits<{
  (e: 'update:modelValue', value: boolean): void
  (e: 'success'): void
}>()

const memberStore = useMemberStore()

// è°ƒè¯•props
console.log('ğŸ” MemberDialog props:', {
  visible: props.visible,
  editData: props.editData,
  hasEditData: !!props.editData
})
const formRef = ref<FormInstance>()
const loading = ref(false)

const form = reactive<MemberForm>({
  name: '',
  gender: '',
  grade: '',
  phone: '',
  email: '',
  department_id: null,
  role_id: null
})

const dialogVisible = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value)
})

const dialogTitle = computed(() => {
  return props.editData ? 'ç¼–è¾‘æˆå‘˜' : 'æ·»åŠ æˆå‘˜'
})

const rules = computed<FormRules>(() => {
  const baseRules: FormRules = {
    name: [
      { required: true, message: 'è¯·è¾“å…¥å§“å', trigger: 'blur' }
    ],
    gender: [
      { required: true, message: 'è¯·é€‰æ‹©æ€§åˆ«', trigger: 'change' }
    ],
    grade: [
      { required: true, message: 'è¯·é€‰æ‹©å¹´çº§', trigger: 'change' }
    ],
    role_id: [
      { required: true, message: 'è¯·é€‰æ‹©èŒä½', trigger: 'change' }
    ]
  }
  
  if (form.role_id !== 1) {
    baseRules.department_id = [
      { required: true, message: 'è¯·é€‰æ‹©éƒ¨é—¨', trigger: 'change' }
    ]
  }
  
  return baseRules
})

const handleRoleChange = (roleId: number) => {
  if (roleId === 1) {
    form.department_id = null
  }
}

const resetForm = () => {
  form.name = ''
  form.gender = ''
  form.grade = ''
  form.phone = ''
  form.email = ''
  form.department_id = null
  form.role_id = null
  formRef.value?.clearValidate()
}

const handleBeforeClose = (done: () => void) => {
  handleClose()
  done()
}

const handleClose = () => {
  console.log('å…³é—­å¯¹è¯æ¡†')
  dialogVisible.value = false
  resetForm()
}

const handleSubmit = async () => {
  if (!formRef.value) return

  try {
    const valid = await formRef.value.validate()
    if (!valid) return

    loading.value = true

    if (props.editData) {
      await memberStore.updateMember(props.editData.id, form)
      ElMessage.success('æ›´æ–°æˆåŠŸ')
    } else {
      await memberStore.createMember(form)
      ElMessage.success('åˆ›å»ºæˆåŠŸ')
    }

    emit('success')
    handleClose()
  } catch (error) {
    console.error('æäº¤å¤±è´¥:', error)
    ElMessage.error('æ“ä½œå¤±è´¥')
  } finally {
    loading.value = false
  }
}

watch(() => props.visible, (newVal) => {
  console.log('ğŸ‘€ å¯¹è¯æ¡†å¯è§æ€§å˜åŒ–:', newVal)
  if (newVal) {
    nextTick(() => {
      console.log('ğŸ“‹ å‡†å¤‡å¡«å……è¡¨å•æ•°æ®ï¼ŒeditData:', props.editData)
      if (props.editData) {
        // ç¼–è¾‘æ¨¡å¼ï¼šå¡«å……è¡¨å•æ•°æ®
        console.log('ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……æ•°æ®:', props.editData)
        Object.assign(form, {
          name: props.editData.name || '',
          gender: props.editData.gender || '',
          grade: props.editData.grade || '',
          phone: props.editData.phone || '',
          email: props.editData.email || '',
          department_id: props.editData.department_id || null,
          role_id: props.editData.role_id || null
        })
      } else {
        // æ·»åŠ æ¨¡å¼ï¼šé‡ç½®è¡¨å•
        console.log('æ·»åŠ æ¨¡å¼ï¼Œé‡ç½®è¡¨å•')
        resetForm()
      }
    })
  }
})
</script>

<style scoped>
.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}
</style>

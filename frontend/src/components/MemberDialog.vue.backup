<template>
  <el-dialog
    :model-value="visible"
    @update:model-value="closeDialog"
    :title="props.editData ? 'ç¼–è¾‘æˆå‘˜' : 'æ·»åŠ æˆå‘˜'"
    width="600px"
  >
    <el-form :model="formData" label-width="100px">
      <el-form-item label="å§“å">
        <el-input v-model="formData.name" placeholder="è¯·è¾“å…¥å§“å" />
      </el-form-item>
      <el-form-item label="æ€§åˆ«">
        <el-radio-group v-model="formData.gender">
          <el-radio label="ç”·">ç”·</el-radio>
          <el-radio label="å¥³">å¥³</el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item label="å¹´çº§">
        <el-input v-model="formData.grade" placeholder="è¯·è¾“å…¥å¹´çº§" />
      </el-form-item>
      <el-form-item label="ç”µè¯">
        <el-input v-model="formData.phone" placeholder="è¯·è¾“å…¥ç”µè¯" />
      </el-form-item>
      <el-form-item label="é‚®ç®±">
        <el-input v-model="formData.email" placeholder="è¯·è¾“å…¥é‚®ç®±" />
      </el-form-item>
      <el-form-item label="éƒ¨é—¨">
        <el-select 
          v-model="formData.department_id" 
          placeholder="formData.role_id === 1 ? "ç«™é•¿æ— éœ€é€‰æ‹©éƒ¨é—¨" : "è¯·é€‰æ‹©éƒ¨é—¨""
          clearable
          :disabled="formData.role_id === 1"
        >
          <el-option
            v-for="dept in departments"
            :key="dept.id"
            :label="dept.name"
            :value="dept.id"
          />
        </el-select>
        <div v-if="departments.length === 0" style="color: #f56c6c; font-size: 12px;">
          æš‚æ— éƒ¨é—¨æ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯API
        </div>
      </el-form-item>
      <el-form-item label="èŒä½">
        <el-select 
          v-model="formData.role_id" 
          placeholder="è¯·é€‰æ‹©èŒä½"
          clearable
        >
          <el-option
            v-for="role in roles"
            :key="role.id"
            :label="role.title"
            :value="role.id"
          />
        </el-select>
        <div v-if="roles.length === 0" style="color: #f56c6c; font-size: 12px;">
          æš‚æ— èŒä½æ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯API
        </div>
      </el-form-item>
    </el-form>
    
    <template #footer>
      <span class="dialog-footer">
        <el-button @click="closeDialog">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleSubmit">ç¡®å®š</el-button>
      </span>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, watch, onMounted } from 'vue'
import { useMemberStore } from '@/stores/member'

interface MemberFormData {
  name: string
  gender: string
  grade: string
  phone: string
  email: string
  department_id: number | null
  role_id: number | null
}

interface Department {
  id: number
  name: string
}

interface Role {
  id: number
  role_title: string
}

const props = defineProps<{
  visible: boolean
  editData?: any
}>()

const emit = defineEmits<{
  (e: 'update:visible', value: boolean): void
  (e: 'success'): void
}>()

const memberStore = useMemberStore()
const departments = ref<Department[]>([])
const roles = ref<Role[]>([])

// è¡¨å•æ•°æ®
const formData = ref<MemberFormData>({
  name: '',
  gender: '',
  grade: '',
  phone: '',
  email: '',
  department_id: null,
  role_id: null
})

// åŠ è½½éƒ¨é—¨å’ŒèŒä½æ•°æ®
const loadSelectData = async () => {
  console.log('ğŸ”„ å¼€å§‹åŠ è½½ä¸‹æ‹‰æ¡†æ•°æ®...')
  
  try {
    // åŠ è½½éƒ¨é—¨æ•°æ®
    console.log('æ­£åœ¨è·å–éƒ¨é—¨æ•°æ®...')
    await memberStore.fetchDepartments()
    departments.value = memberStore.departments
    console.log('âœ… éƒ¨é—¨æ•°æ®:', departments.value)
  } catch (error) {
    console.error('âŒ åŠ è½½éƒ¨é—¨æ•°æ®å¤±è´¥:', error)
    departments.value = []
  }
  
  try {
    // åŠ è½½èŒä½æ•°æ®
    console.log('æ­£åœ¨è·å–èŒä½æ•°æ®...')
    await memberStore.fetchRoles()
    roles.value = memberStore.roles
    console.log('âœ… èŒä½æ•°æ®:', roles.value)
  } catch (error) {
    console.error('âŒ åŠ è½½èŒä½æ•°æ®å¤±è´¥:', error)
    roles.value = []
  }
}

// ç›‘å¬ç¼–è¾‘æ•°æ®å˜åŒ–
watch(() => props.editData, (newVal) => {
  console.log('ğŸ“ ç¼–è¾‘æ•°æ®å˜åŒ–:', newVal)
  if (newVal) {
    formData.value = {
      name: newVal.name || '',
      gender: newVal.gender || '',
      grade: newVal.grade || '',
      phone: newVal.phone || '',
      email: newVal.email || '',
      department_id: newVal.department_id || null,
      role_id: newVal.role_id || null
    }
    console.log('âœ… è¡¨å•æ•°æ®å·²å¡«å……:', formData.value)
  } else {
    // é‡ç½®è¡¨å•
    formData.value = {
      name: '',
      gender: '',
      grade: '',
      phone: '',
      email: '',
      department_id: null,
      role_id: null
    }
  }
}, { immediate: true })

// ç›‘å¬å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€ï¼Œæ˜¾ç¤ºæ—¶åŠ è½½æ•°æ®
watch(() => props.visible, (newVal) => {
  if (newVal) {
    console.log('ğŸ¯ å¯¹è¯æ¡†æ‰“å¼€ï¼ŒåŠ è½½æ•°æ®...')
    loadSelectData()
  }
})

// ç»„ä»¶æŒ‚è½½æ—¶ä¹ŸåŠ è½½ä¸€æ¬¡æ•°æ®
onMounted(() => {
  console.log('ğŸ—ï¸ MemberDialog ç»„ä»¶å·²æŒ‚è½½')
  if (props.visible) {
    loadSelectData()
  }
})

// å…³é—­å¯¹è¯æ¡†
const closeDialog = () => {
  console.log('ğŸ”’ å…³é—­å¯¹è¯æ¡†')
  emit('update:visible', false)
}

// æäº¤è¡¨å•

// æäº¤è¡¨å•
const handleSubmit = async () => {
  console.log('ğŸ“¤ æäº¤è¡¨å•æ•°æ®:', formData.value)
  
  // ç¡®ä¿æ²¡æœ‰undefinedå€¼ï¼Œè½¬æ¢ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²
  const submitData = {
    name: formData.value.name || '',
    gender: formData.value.gender || '',
    grade: formData.value.grade || '',
    phone: formData.value.phone || '',
    email: formData.value.email || '',
    department_id: formData.value.department_id || null,
    role_id: formData.value.role_id || null
  }
  
  console.log('ğŸ“¤ å¤„ç†åçš„æäº¤æ•°æ®:', submitData)
  
  try {
    if (props.editData) {
      // ç¼–è¾‘æ¨¡å¼
      await memberStore.updateMember(props.editData.id, submitData)
    } else {
      // æ·»åŠ æ¨¡å¼
      await memberStore.addMember(submitData)
    }
    emit('success')
    closeDialog()
  } catch (error) {
    console.error('âŒ æäº¤å¤±è´¥:', error)
  }
} else {
      // æ·»åŠ æ¨¡å¼
      await memberStore.addMember(formData.value)
    }
    emit('success')
    closeDialog()
  } catch (error) {
    console.error('âŒ æäº¤å¤±è´¥:', error)
  }
}
</script>

<style scoped>
.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
</style>
